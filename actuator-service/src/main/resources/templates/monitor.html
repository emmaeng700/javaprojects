<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Performance Monitor')}"></head>
<body>
<nav th:replace="~{fragments/layout :: nav('monitor')}"></nav>
<div th:replace="~{fragments/layout :: shortcuts}"></div>
<div th:replace="~{fragments/layout :: toasts}"></div>

<div class="container-wide">

    <!-- Header -->
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
        <div>
            <h1>Performance Monitor</h1>
            <div class="subtitle">Real-time JVM metrics streamed via Server-Sent Events</div>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="sse-indicator" id="sse-status">
                <span class="sse-dot"></span> SSE Connected
            </div>
            <div class="live-indicator">
                <span class="live-dot"></span> LIVE
            </div>
        </div>
    </div>

    <!-- SVG Gauges -->
    <div class="gauge-grid">
        <div class="gauge-card">
            <svg width="110" height="110" viewBox="0 0 140 140">
                <circle cx="70" cy="70" r="58" fill="none" stroke="var(--primary)" stroke-width="10" class="gauge-bg"/>
                <circle id="gauge-mem-fill" cx="70" cy="70" r="58" fill="none"
                        stroke="var(--primary)" stroke-width="10" class="gauge-fill"
                        stroke-dasharray="364.42" stroke-dashoffset="364.42"
                        stroke-linecap="round" transform="rotate(-90 70 70)"/>
                <text x="70" y="64" text-anchor="middle" dominant-baseline="central" class="gauge-value" id="gauge-mem-val">0%</text>
                <text x="70" y="84" text-anchor="middle" class="gauge-sub" id="gauge-mem-sub">0 / 0 MB</text>
            </svg>
            <div class="gauge-label">Heap Memory</div>
        </div>
        <div class="gauge-card">
            <svg width="110" height="110" viewBox="0 0 140 140">
                <circle cx="70" cy="70" r="58" fill="none" stroke="var(--accent)" stroke-width="10" class="gauge-bg"/>
                <circle id="gauge-thread-fill" cx="70" cy="70" r="58" fill="none"
                        stroke="var(--accent)" stroke-width="10" class="gauge-fill"
                        stroke-dasharray="364.42" stroke-dashoffset="364.42"
                        stroke-linecap="round" transform="rotate(-90 70 70)"/>
                <text x="70" y="64" text-anchor="middle" dominant-baseline="central" class="gauge-value" id="gauge-thread-val">0</text>
                <text x="70" y="84" text-anchor="middle" class="gauge-sub" id="gauge-thread-sub">threads</text>
            </svg>
            <div class="gauge-label">Live Threads</div>
        </div>
        <div class="gauge-card">
            <svg width="110" height="110" viewBox="0 0 140 140">
                <circle cx="70" cy="70" r="58" fill="none" stroke="var(--warm)" stroke-width="10" class="gauge-bg"/>
                <circle id="gauge-cpu-fill" cx="70" cy="70" r="58" fill="none"
                        stroke="var(--warm)" stroke-width="10" class="gauge-fill"
                        stroke-dasharray="364.42" stroke-dashoffset="364.42"
                        stroke-linecap="round" transform="rotate(-90 70 70)"/>
                <text x="70" y="64" text-anchor="middle" dominant-baseline="central" class="gauge-value" id="gauge-cpu-val">0%</text>
                <text x="70" y="84" text-anchor="middle" class="gauge-sub" id="gauge-cpu-sub">process CPU</text>
            </svg>
            <div class="gauge-label">CPU Usage</div>
        </div>
    </div>

    <!-- Memory Chart (full width) -->
    <div class="card">
        <h2>JVM Heap Memory</h2>
        <div class="chart-container">
            <canvas id="memoryChart"></canvas>
        </div>
    </div>

    <!-- Thread + CPU Charts side by side -->
    <div class="grid-2">
        <div class="card">
            <h2>Thread Count</h2>
            <div class="chart-container-sm">
                <canvas id="threadChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>CPU Usage</h2>
            <div class="chart-container-sm">
                <canvas id="cpuChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Thread States + Bean Summary -->
    <div class="grid-2">
        <div class="card">
            <h2>Thread States</h2>
            <div style="height:160px;display:flex;justify-content:center;">
                <canvas id="threadStateChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Application Info</h2>
            <div id="app-summary" style="font-size:13px;color:var(--text-muted);">Loading...</div>
        </div>
    </div>

</div>

<script th:inline="javascript">
var MAX_POINTS = 150;
var CIRC = 364.42; // 2 * PI * 58

// === Chart.js Setup ===
var chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 300 },
    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } },
    scales: {
        x: { display: true, grid: { display: false }, ticks: { maxTicksLimit: 8, font: { size: 10 }, color: '#94a3b8' } },
        y: { display: true, grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { font: { size: 10 }, color: '#94a3b8' } }
    }
};

// Memory Chart
var memCtx = document.getElementById('memoryChart').getContext('2d');
var memoryChart = new Chart(memCtx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Used', data: [], borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.15)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 },
            { label: 'Committed', data: [], borderColor: '#94a3b8', borderDash: [5,3], fill: false, tension: 0.3, pointRadius: 0, borderWidth: 1.5 },
            { label: 'Max', data: [], borderColor: '#ef4444', borderDash: [2,2], fill: false, tension: 0, pointRadius: 0, borderWidth: 1 }
        ]
    },
    options: { ...chartDefaults, scales: { ...chartDefaults.scales, y: { ...chartDefaults.scales.y, ticks: { ...chartDefaults.scales.y.ticks, callback: function(v) { return Math.round(v) + ' MB'; } } } } }
});

// Thread Chart
var threadCtx = document.getElementById('threadChart').getContext('2d');
var threadChart = new Chart(threadCtx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Live', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 },
            { label: 'Daemon', data: [], borderColor: '#94a3b8', borderDash: [4,3], fill: false, tension: 0.3, pointRadius: 0, borderWidth: 1.5 }
        ]
    },
    options: chartDefaults
});

// CPU Chart
var cpuCtx = document.getElementById('cpuChart').getContext('2d');
var cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'Process', data: [], borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2 },
            { label: 'System', data: [], borderColor: '#f59e0b', borderDash: [4,3], fill: false, tension: 0.3, pointRadius: 0, borderWidth: 1.5 }
        ]
    },
    options: { ...chartDefaults, scales: { ...chartDefaults.scales, y: { ...chartDefaults.scales.y, min: 0, max: 100, ticks: { ...chartDefaults.scales.y.ticks, callback: function(v) { return v + '%'; } } } } }
});

// Thread State Doughnut
var stateCtx = document.getElementById('threadStateChart').getContext('2d');
var threadStateChart = new Chart(stateCtx, {
    type: 'doughnut',
    data: {
        labels: ['Runnable', 'Waiting', 'Timed Waiting', 'Blocked'],
        datasets: [{ data: [0,0,0,0], backgroundColor: ['#10b981','#f59e0b','#6366f1','#ef4444'], borderWidth: 0 }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 10, font: { size: 11 } } } }
    }
});

// === Helper Functions ===
function formatTime(ts) {
    var d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function toMB(bytes) {
    return (bytes / (1024 * 1024)).toFixed(1);
}

function setGauge(fillId, valId, subId, percent, valText, subText) {
    var offset = CIRC * (1 - Math.min(percent, 1));
    document.getElementById(fillId).setAttribute('stroke-dashoffset', offset);
    document.getElementById(valId).textContent = valText;
    if (subId) document.getElementById(subId).textContent = subText;
}

function pushPoint(chart, label, values) {
    chart.data.labels.push(label);
    for (var i = 0; i < values.length; i++) {
        chart.data.datasets[i].data.push(values[i]);
    }
    while (chart.data.labels.length > MAX_POINTS) {
        chart.data.labels.shift();
        for (var i = 0; i < chart.data.datasets.length; i++) {
            chart.data.datasets[i].data.shift();
        }
    }
    chart.update('none');
}

// === Update from Snapshot ===
function updateFromSnapshot(s) {
    var usedMB = parseFloat(toMB(s.heapUsed));
    var maxMB = parseFloat(toMB(s.heapMax));
    var committedMB = parseFloat(toMB(s.heapCommitted));
    var memPct = maxMB > 0 ? usedMB / maxMB : 0;
    var label = formatTime(s.timestamp);

    // Gauges
    setGauge('gauge-mem-fill', 'gauge-mem-val', 'gauge-mem-sub',
             memPct, Math.round(memPct * 100) + '%', usedMB.toFixed(0) + ' / ' + maxMB.toFixed(0) + ' MB');
    setGauge('gauge-thread-fill', 'gauge-thread-val', 'gauge-thread-sub',
             Math.min(s.threadCount / 200, 1), s.threadCount, s.daemonThreadCount + ' daemon');
    setGauge('gauge-cpu-fill', 'gauge-cpu-val', 'gauge-cpu-sub',
             s.cpuUsage / 100, s.cpuUsage.toFixed(1) + '%', 'process CPU');

    // Charts
    pushPoint(memoryChart, label, [usedMB, committedMB, maxMB]);
    pushPoint(threadChart, label, [s.threadCount, s.daemonThreadCount]);
    pushPoint(cpuChart, label, [s.cpuUsage, s.systemCpuUsage]);
}

// === Load Initial History ===
fetch('/api/metrics/history?count=150')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        // Data comes most-recent-first, reverse for chronological
        var sorted = data.reverse();
        for (var i = 0; i < sorted.length; i++) {
            updateFromSnapshot(sorted[i]);
        }
    })
    .catch(function() {
        showToast('Failed to load metric history', true);
    });

// === SSE Connection ===
var eventSource = new EventSource('/api/events');
var sseStatus = document.getElementById('sse-status');

eventSource.addEventListener('metrics', function(e) {
    var snapshot = JSON.parse(e.data);
    updateFromSnapshot(snapshot);
});

eventSource.addEventListener('greeting', function(e) {
    var g = JSON.parse(e.data);
    showToast('New greeting: ' + g.name);
});

eventSource.addEventListener('open', function() {
    sseStatus.className = 'sse-indicator';
    sseStatus.innerHTML = '<span class="sse-dot"></span> SSE Connected';
});

eventSource.onerror = function() {
    sseStatus.className = 'sse-indicator disconnected';
    sseStatus.innerHTML = '<span class="sse-dot"></span> Reconnecting...';
};

// === Thread State Breakdown ===
function refreshThreadStates() {
    fetch('/api/actuator/threaddump')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var states = { RUNNABLE: 0, WAITING: 0, TIMED_WAITING: 0, BLOCKED: 0 };
            var threads = d.threads || [];
            for (var i = 0; i < threads.length; i++) {
                var st = threads[i].threadState;
                if (states.hasOwnProperty(st)) states[st]++;
                else if (st === 'NEW') states.RUNNABLE++;
                else if (st === 'TERMINATED') {} // skip
            }
            threadStateChart.data.datasets[0].data = [states.RUNNABLE, states.WAITING, states.TIMED_WAITING, states.BLOCKED];
            threadStateChart.update();
        })
        .catch(function() {});
}
refreshThreadStates();
setInterval(refreshThreadStates, 10000);

// === App Info Summary ===
function loadAppInfo() {
    Promise.all([
        fetch('/api/actuator/info').then(function(r) { return r.json(); }),
        fetch('/api/actuator/beans').then(function(r) { return r.json(); }),
        fetch('/api/system').then(function(r) { return r.json(); })
    ]).then(function(results) {
        var info = results[0];
        var beans = results[1];
        var sys = results[2];

        // Count beans
        var beanCount = 0;
        var contexts = beans.contexts || {};
        for (var ctx in contexts) {
            if (contexts.hasOwnProperty(ctx)) {
                var b = contexts[ctx].beans || {};
                beanCount += Object.keys(b).length;
            }
        }

        var html = '<div style="display:flex;flex-direction:column;gap:12px;">';
        html += '<div class="sparkline-card" style="margin:0;padding:12px;">';
        html += '<div class="sparkline-label">Application</div>';
        html += '<div style="font-size:16px;font-weight:700;color:var(--dark);">' + (info.app ? info.app.name : 'Actuator Service') + '</div>';
        html += '<div style="font-size:12px;color:var(--text-muted);">v' + (info.app ? info.app.version : '1.0.0') + '</div>';
        html += '</div>';

        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">';
        html += '<div class="sparkline-card" style="margin:0;padding:12px;text-align:center;">';
        html += '<div class="sparkline-value" style="font-size:28px;color:var(--primary);">' + beanCount + '</div>';
        html += '<div class="sparkline-label">Spring Beans</div></div>';

        html += '<div class="sparkline-card" style="margin:0;padding:12px;text-align:center;">';
        html += '<div class="sparkline-value" style="font-size:28px;color:var(--accent);">' + sys.runtime.availableProcessors + '</div>';
        html += '<div class="sparkline-label">CPU Cores</div></div>';
        html += '</div>';

        html += '<div class="sparkline-card" style="margin:0;padding:12px;">';
        html += '<div class="sparkline-label">Runtime</div>';
        html += '<div style="font-size:12px;line-height:1.8;">';
        html += 'Java ' + sys.runtime.javaVersion + '<br>';
        html += sys.jvm.name + '<br>';
        html += sys.runtime.osName + ' (' + sys.runtime.osArch + ')<br>';
        html += 'PID: ' + sys.runtime.pid;
        html += '</div></div>';

        html += '</div>';
        document.getElementById('app-summary').innerHTML = html;
    }).catch(function() {
        document.getElementById('app-summary').textContent = 'Failed to load application info';
    });
}
loadAppInfo();
</script>

<script th:replace="~{fragments/layout :: themeScript}"></script>
</body>
</html>
