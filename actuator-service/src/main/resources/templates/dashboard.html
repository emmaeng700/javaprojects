<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Dashboard')}"></head>
<body>
<nav th:replace="~{fragments/layout :: nav('dashboard')}"></nav>

<div class="container-wide">
    <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
            <div>
                <h1>Service Dashboard</h1>
                <p class="subtitle">Real-time monitoring for your Spring Boot Actuator service</p>
            </div>
            <div style="text-align:right">
                <div style="display:flex;align-items:center;gap:12px;justify-content:flex-end;">
                    <div class="sse-indicator" id="sse-status">
                        <span class="sse-dot"></span> SSE
                    </div>
                    <div class="live-indicator"><span class="live-dot"></span> LIVE</div>
                </div>
                <div class="uptime-display" id="uptime">--</div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="stats-grid">
        <div class="stat-card green" id="health-card">
            <div class="stat-value">
                <span class="status-badge up" id="health-badge">
                    <span class="status-dot"></span> UP
                </span>
            </div>
            <div class="stat-label">Health Status</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="greeting-count">0</div>
            <div class="stat-label">Greetings Served</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unique-names">0</div>
            <div class="stat-label">Unique Names</div>
        </div>
        <div class="stat-card amber">
            <div class="stat-value">
                <svg width="48" height="48" viewBox="0 0 48 48" style="vertical-align:middle;">
                    <circle cx="24" cy="24" r="20" fill="none" stroke="var(--warm)" stroke-width="4" opacity="0.2"/>
                    <circle id="mini-mem-gauge" cx="24" cy="24" r="20" fill="none" stroke="var(--warm)" stroke-width="4"
                            stroke-dasharray="125.66" stroke-dashoffset="125.66" stroke-linecap="round" transform="rotate(-90 24 24)"
                            style="transition:stroke-dashoffset 0.8s ease;"/>
                </svg>
                <span id="mini-mem-pct" style="margin-left:6px;">0%</span>
            </div>
            <div class="stat-label">Heap Memory</div>
        </div>
    </div>


    <div class="grid-2">
        <!-- Quick Greeting Test -->
        <div class="card">
            <h2>Quick Greeting</h2>
            <div class="api-form">
                <input type="text" class="api-input" id="greet-name" placeholder="Enter a name...">
                <button class="btn btn-primary" onclick="sendGreeting()">Greet</button>
            </div>
            <div class="response-box" id="greet-response">Click "Greet" to test the /hello-world endpoint</div>
        </div>

        <!-- Top Names Leaderboard -->
        <div class="card">
            <h2>Top Greeted Names</h2>
            <div id="leaderboard" class="leaderboard">
                <p style="color:var(--text-muted);padding:16px;text-align:center">Send some greetings to see the leaderboard</p>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Health Details -->
        <div class="card">
            <h2>Health Details</h2>
            <div id="health-details" class="response-box">Loading...</div>
        </div>

        <!-- Greeting Activity Chart -->
        <div class="card">
            <h2>Greeting Activity</h2>
            <div class="chart-container-sm">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Greeting History -->
    <div class="card">
        <h2>Recent Greetings</h2>
        <table>
            <thead>
                <tr><th>#</th><th>Name</th><th>Message</th><th>Time</th></tr>
            </thead>
            <tbody id="history-body">
                <tr><td colspan="4" style="color:var(--text-muted);text-align:center">No greetings yet</td></tr>
            </tbody>
        </table>
    </div>

    <!-- App Info -->
    <div class="card">
        <h2>Application Info</h2>
        <div id="app-info" class="response-box">Loading...</div>
    </div>
</div>

<script>
// Activity bar chart (greetings per minute)
var activityBuckets = new Array(10).fill(0);
var activityLabels = [];
for (var i = 9; i >= 0; i--) activityLabels.push(i === 0 ? 'now' : i + 'm ago');
var actCtx = document.getElementById('activityChart').getContext('2d');
var activityChart = new Chart(actCtx, {
    type: 'bar',
    data: { labels: activityLabels, datasets: [{ data: activityBuckets, backgroundColor: 'rgba(99,102,241,0.6)', borderRadius: 4, borderSkipped: false }] },
    options: {
        responsive: true, maintainAspectRatio: false, animation: { duration: 300 },
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false }, ticks: { font: { size: 10 }, color: '#94a3b8' } }, y: { display: false, beginAtZero: true } }
    }
});


// Track greeting timestamps for per-minute bucketing
var greetingTimestamps = [];
function recordGreetingTime() {
    greetingTimestamps.push(Date.now());
}
function recalcActivity() {
    var now = Date.now();
    var cutoff = now - 10 * 60 * 1000;
    greetingTimestamps = greetingTimestamps.filter(function(t) { return t > cutoff; });
    var buckets = new Array(10).fill(0);
    for (var j = 0; j < greetingTimestamps.length; j++) {
        var ago = Math.floor((now - greetingTimestamps[j]) / 60000);
        if (ago < 10) buckets[9 - ago]++;
    }
    activityChart.data.datasets[0].data = buckets;
    activityChart.update('none');
}
setInterval(recalcActivity, 5000);

// === Confetti ===
var lastGreetingCount = 0;
var MILESTONES = [10, 25, 50, 100, 250, 500, 1000];
function checkMilestone(newCount) {
    for (var i = 0; i < MILESTONES.length; i++) {
        if (newCount >= MILESTONES[i] && lastGreetingCount < MILESTONES[i]) {
            launchConfetti();
            showToast('Milestone: ' + MILESTONES[i] + ' greetings!');
            break;
        }
    }
    lastGreetingCount = newCount;
}
function launchConfetti() {
    var colors = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
    for (var i = 0; i < 60; i++) {
        var el = document.createElement('div');
        el.className = 'confetti-piece';
        el.style.left = Math.random() * 100 + 'vw';
        el.style.top = '-10px';
        el.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.style.animationDelay = (Math.random() * 0.5) + 's';
        el.style.animationDuration = (1.5 + Math.random() * 1.5) + 's';
        el.style.width = (6 + Math.random() * 6) + 'px';
        el.style.height = (6 + Math.random() * 6) + 'px';
        document.body.appendChild(el);
        setTimeout(function(e) { e.remove(); }.bind(null, el), 3000);
    }
}

// === Avatar Color Generator ===
function nameColor(name) {
    var hash = 0;
    for (var i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    var hue = Math.abs(hash) % 360;
    return 'hsl(' + hue + ', 65%, 55%)';
}

// === Greeting ===
function sendGreeting() {
    var name = document.getElementById('greet-name').value.trim();
    if (name === '') {
        document.getElementById('greet-response').textContent = 'Please enter a name.';
        document.getElementById('greet-name').focus();
        return;
    }
    fetch('/hello-world?name=' + encodeURIComponent(name))
        .then(function(r) { return r.json(); })
        .then(function(d) {
            document.getElementById('greet-response').textContent = JSON.stringify(d, null, 2);
            document.getElementById('greet-name').value = '';
            recordGreetingTime();
            recalcActivity();
            refreshStats();
            refreshHistory();
        })
        .catch(function(e) {
            document.getElementById('greet-response').textContent = 'Error: ' + e.message;
        });
}
document.getElementById('greet-name').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendGreeting();
});

// === Stats & Leaderboard ===
function refreshStats() {
    fetch('/api/greetings/stats')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            animateCounter('greeting-count', d.totalGreetings);
            animateCounter('unique-names', d.uniqueNames);
            checkMilestone(d.totalGreetings);
            renderLeaderboard(d.topNames || []);
        })
        .catch(function() {});
}

function animateCounter(id, target) {
    var el = document.getElementById(id);
    var current = parseInt(el.textContent) || 0;
    if (current === target) return;
    el.classList.add('bumped');
    setTimeout(function() { el.classList.remove('bumped'); }, 300);
    var step = target > current ? 1 : -1;
    var delay = Math.max(20, 300 / Math.abs(target - current));
    function tick() {
        current += step;
        el.textContent = current;
        if (current !== target) setTimeout(tick, delay);
    }
    tick();
}

function renderLeaderboard(topNames) {
    var el = document.getElementById('leaderboard');
    if (topNames.length === 0) {
        el.innerHTML = '<p style="color:var(--text-muted);padding:16px;text-align:center">Send some greetings to see the leaderboard</p>';
        return;
    }
    var maxCount = topNames[0].count;
    el.innerHTML = topNames.map(function(item, i) {
        var pct = Math.round((item.count / maxCount) * 100);
        var rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        var initial = item.name.charAt(0).toUpperCase();
        return '<div class="lb-row">' +
            '<div class="lb-avatar" style="background:' + nameColor(item.name) + '">' + initial + '</div>' +
            '<span class="lb-rank ' + rankClass + '">#' + (i + 1) + '</span>' +
            '<span class="lb-name">' + item.name + '</span>' +
            '<div class="lb-bar-track"><div class="lb-bar-fill" style="width:' + pct + '%"></div></div>' +
            '<span class="lb-count">' + item.count + '</span>' +
            '</div>';
    }).join('');
}

// === History ===
function refreshHistory() {
    fetch('/api/greetings/history')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var body = document.getElementById('history-body');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="4" style="color:var(--text-muted);text-align:center">No greetings yet</td></tr>';
                return;
            }
            body.innerHTML = data.slice(0, 10).map(function(g) {
                var time = new Date(g.timestamp).toLocaleTimeString();
                return '<tr><td>' + g.id + '</td><td><div style="display:flex;align-items:center;gap:6px;"><div class="lb-avatar" style="width:22px;height:22px;font-size:10px;background:' + nameColor(g.name) + '">' + g.name.charAt(0).toUpperCase() + '</div><strong>' + g.name + '</strong></div></td><td><code>' + g.content + '</code></td><td>' + time + '</td></tr>';
            }).join('');
        })
        .catch(function() {});
}

// === Health ===
function refreshHealth() {
    fetch('/api/actuator/health')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            document.getElementById('health-details').textContent = JSON.stringify(d, null, 2);
            var badge = document.getElementById('health-badge');
            if (d.status === 'UP') {
                badge.className = 'status-badge up';
                badge.innerHTML = '<span class="status-dot"></span> UP';
            } else {
                badge.className = 'status-badge down';
                badge.innerHTML = '<span class="status-dot"></span> DOWN';
            }
        })
        .catch(function() {
            document.getElementById('health-details').textContent = 'Could not reach health endpoint';
        });
}

// === Uptime ===
var uptimeStart = null;
function refreshUptime() {
    fetch('/api/actuator/metrics/process.uptime')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            uptimeStart = Date.now() - (d.measurements[0].value * 1000);
        })
        .catch(function() {});
}
function tickUptime() {
    if (uptimeStart) {
        var elapsed = Math.floor((Date.now() - uptimeStart) / 1000);
        var h = Math.floor(elapsed / 3600);
        var m = Math.floor((elapsed % 3600) / 60);
        var s = elapsed % 60;
        document.getElementById('uptime').textContent = (h > 0 ? h + 'h ' : '') + m + 'm ' + s + 's';
    }
    requestAnimationFrame(tickUptime);
}

// === App Info ===
fetch('/api/actuator/info')
    .then(function(r) { return r.json(); })
    .then(function(d) {
        document.getElementById('app-info').textContent = JSON.stringify(d, null, 2);
    })
    .catch(function() {
        document.getElementById('app-info').textContent = 'Not available';
    });

// === SSE Connection ===
var eventSource = new EventSource('/api/events');
var sseStatus = document.getElementById('sse-status');

eventSource.addEventListener('metrics', function(e) {
    var s = JSON.parse(e.data);
    var usedMB = (s.heapUsed / 1048576).toFixed(1);
    var maxMB = (s.heapMax / 1048576).toFixed(1);
    var memPct = maxMB > 0 ? (usedMB / maxMB) : 0;

    // Mini gauge
    document.getElementById('mini-mem-gauge').setAttribute('stroke-dashoffset', 125.66 * (1 - memPct));
    document.getElementById('mini-mem-pct').textContent = Math.round(memPct * 100) + '%';
});

eventSource.addEventListener('greeting', function(e) {
    var g = JSON.parse(e.data);
    showToast('Hello, ' + g.name + '!');
    recordGreetingTime();
    recalcActivity();
    refreshStats();
    refreshHistory();
});

eventSource.onerror = function() {
    sseStatus.className = 'sse-indicator disconnected';
    sseStatus.innerHTML = '<span class="sse-dot"></span> Reconnecting';
};

// === Initial Load ===
refreshHealth();
refreshStats();
refreshHistory();
refreshUptime();
tickUptime();

// Health refresh every 30s (not via SSE)
setInterval(refreshHealth, 30000);
</script>

<div th:replace="~{fragments/layout :: shortcuts}"></div>
<div th:replace="~{fragments/layout :: toasts}"></div>
<script th:replace="~{fragments/layout :: themeScript}"></script>
</body>
</html>
