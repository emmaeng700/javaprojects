<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Dashboard')}"></head>
<body>
<nav th:replace="~{fragments/layout :: nav('dashboard')}"></nav>

<div class="container-wide">
    <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <h1>Service Dashboard</h1>
                <p class="subtitle">Real-time monitoring for your Spring Boot Actuator service</p>
            </div>
            <div style="text-align:right">
                <div class="live-indicator"><span class="live-dot"></span> LIVE</div>
                <div class="uptime-display" id="uptime">--</div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="stats-grid">
        <div class="stat-card green" id="health-card">
            <div class="stat-value">
                <span class="status-badge up" id="health-badge">
                    <span class="status-dot"></span> UP
                </span>
            </div>
            <div class="stat-label">Health Status</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="greeting-count">0</div>
            <div class="stat-label">Greetings Served</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unique-names">0</div>
            <div class="stat-label">Unique Names</div>
        </div>
        <div class="stat-card amber">
            <div class="stat-value" th:text="${serverPort}">9000</div>
            <div class="stat-label">Server Port</div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Quick Greeting Test -->
        <div class="card">
            <h2>Quick Greeting</h2>
            <div class="api-form">
                <input type="text" class="api-input" id="greet-name" placeholder="Enter a name...">
                <button class="btn btn-primary" onclick="sendGreeting()">Greet</button>
            </div>
            <div class="response-box" id="greet-response">Click "Greet" to test the /hello-world endpoint</div>
        </div>

        <!-- Top Names Leaderboard -->
        <div class="card">
            <h2>Top Greeted Names</h2>
            <div id="leaderboard" class="leaderboard">
                <p style="color:var(--text-muted);padding:16px;text-align:center">Send some greetings to see the leaderboard</p>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Health Details -->
        <div class="card">
            <h2>Health Details</h2>
            <div id="health-details" class="response-box">Loading...</div>
        </div>

        <!-- JVM Metrics -->
        <div class="card">
            <h2>JVM Metrics</h2>
            <table id="metrics-table">
                <thead><tr><th>Metric</th><th>Value</th></tr></thead>
                <tbody id="metrics-body">
                    <tr><td colspan="2" style="color:var(--text-muted)">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Greeting History -->
    <div class="card">
        <h2>Recent Greetings</h2>
        <table>
            <thead>
                <tr><th>#</th><th>Name</th><th>Message</th><th>Time</th></tr>
            </thead>
            <tbody id="history-body">
                <tr><td colspan="4" style="color:var(--text-muted);text-align:center">No greetings yet</td></tr>
            </tbody>
        </table>
    </div>

    <!-- App Info -->
    <div class="card">
        <h2>Application Info</h2>
        <div id="app-info" class="response-box">Loading...</div>
    </div>
</div>

<script>
const MGMT = 'http://localhost:' + [[${managementPort}]];
const APP = '';

function sendGreeting() {
    const name = document.getElementById('greet-name').value || 'Stranger';
    fetch(APP + '/hello-world?name=' + encodeURIComponent(name))
        .then(r => r.json())
        .then(d => {
            document.getElementById('greet-response').textContent = JSON.stringify(d, null, 2);
            refreshStats();
            refreshHistory();
        })
        .catch(e => {
            document.getElementById('greet-response').textContent = 'Error: ' + e.message;
        });
}

document.getElementById('greet-name').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendGreeting();
});

// === Stats & Leaderboard ===
function refreshStats() {
    fetch(APP + '/api/greetings/stats')
        .then(r => r.json())
        .then(d => {
            animateCounter('greeting-count', d.totalGreetings);
            animateCounter('unique-names', d.uniqueNames);
            renderLeaderboard(d.topNames || []);
        })
        .catch(function() {});
}

function animateCounter(id, target) {
    var el = document.getElementById(id);
    var current = parseInt(el.textContent) || 0;
    if (current === target) return;
    var step = target > current ? 1 : -1;
    var delay = Math.max(20, 300 / Math.abs(target - current));
    function tick() {
        current += step;
        el.textContent = current;
        if (current !== target) setTimeout(tick, delay);
    }
    tick();
}

function renderLeaderboard(topNames) {
    var el = document.getElementById('leaderboard');
    if (topNames.length === 0) {
        el.innerHTML = '<p style="color:var(--text-muted);padding:16px;text-align:center">Send some greetings to see the leaderboard</p>';
        return;
    }
    var maxCount = topNames[0].count;
    el.innerHTML = topNames.map(function(item, i) {
        var pct = Math.round((item.count / maxCount) * 100);
        var medal = i === 0 ? '&#9733; ' : '';
        return '<div class="lb-row">' +
            '<span class="lb-rank">#' + (i + 1) + '</span>' +
            '<span class="lb-name">' + medal + item.name + '</span>' +
            '<div class="lb-bar-track"><div class="lb-bar-fill" style="width:' + pct + '%"></div></div>' +
            '<span class="lb-count">' + item.count + '</span>' +
            '</div>';
    }).join('');
}

// === History ===
function refreshHistory() {
    fetch(APP + '/api/greetings/history')
        .then(r => r.json())
        .then(function(data) {
            var body = document.getElementById('history-body');
            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="4" style="color:var(--text-muted);text-align:center">No greetings yet</td></tr>';
                return;
            }
            body.innerHTML = data.slice(0, 10).map(function(g) {
                var time = new Date(g.timestamp).toLocaleTimeString();
                return '<tr><td>' + g.id + '</td><td><strong>' + g.name + '</strong></td><td><code>' + g.content + '</code></td><td>' + time + '</td></tr>';
            }).join('');
        })
        .catch(function() {});
}

// === Health (auto-refresh every 10s) ===
function refreshHealth() {
    fetch(MGMT + '/actuator/health')
        .then(r => r.json())
        .then(d => {
            document.getElementById('health-details').textContent = JSON.stringify(d, null, 2);
            var badge = document.getElementById('health-badge');
            if (d.status === 'UP') {
                badge.className = 'status-badge up';
                badge.innerHTML = '<span class="status-dot"></span> UP';
            } else {
                badge.className = 'status-badge down';
                badge.innerHTML = '<span class="status-dot"></span> DOWN';
            }
        })
        .catch(function() {
            document.getElementById('health-details').textContent = 'Could not reach management port ' + MGMT;
        });
}

// === Uptime ===
var uptimeStart = null;
function refreshUptime() {
    fetch(MGMT + '/actuator/metrics/process.uptime')
        .then(r => r.json())
        .then(function(d) {
            uptimeStart = Date.now() - (d.measurements[0].value * 1000);
        })
        .catch(function() {});
}

function tickUptime() {
    if (uptimeStart) {
        var elapsed = Math.floor((Date.now() - uptimeStart) / 1000);
        var h = Math.floor(elapsed / 3600);
        var m = Math.floor((elapsed % 3600) / 60);
        var s = elapsed % 60;
        document.getElementById('uptime').textContent =
            (h > 0 ? h + 'h ' : '') + m + 'm ' + s + 's';
    }
    requestAnimationFrame(tickUptime);
}

// === Info ===
fetch(MGMT + '/actuator/info')
    .then(r => r.json())
    .then(d => {
        document.getElementById('app-info').textContent = JSON.stringify(d, null, 2);
    })
    .catch(function() {
        document.getElementById('app-info').textContent = 'Not available';
    });

// === Metrics ===
function refreshMetrics() {
    var metricNames = ['jvm.memory.used', 'jvm.memory.max', 'system.cpu.count', 'process.uptime', 'jvm.threads.live'];
    var metricsBody = document.getElementById('metrics-body');
    Promise.all(metricNames.map(function(name) {
        return fetch(MGMT + '/actuator/metrics/' + name)
            .then(function(r) { return r.json(); })
            .then(function(d) {
                var val = d.measurements[0].value;
                if (name.includes('memory')) val = (val / 1048576).toFixed(1) + ' MB';
                else if (name === 'process.uptime') {
                    var hrs = Math.floor(val / 3600);
                    var mins = Math.floor((val % 3600) / 60);
                    val = (hrs > 0 ? hrs + 'h ' : '') + mins + 'm ' + Math.round(val % 60) + 's';
                }
                return { name: d.name, value: val };
            })
            .catch(function() { return { name: name, value: 'N/A' }; });
    })).then(function(results) {
        metricsBody.innerHTML = results.map(function(r) {
            return '<tr><td><code>' + r.name + '</code></td><td>' + r.value + '</td></tr>';
        }).join('');
    });
}

// === Initial load & auto-refresh ===
refreshHealth();
refreshMetrics();
refreshStats();
refreshHistory();
refreshUptime();
tickUptime();

setInterval(function() {
    refreshHealth();
    refreshMetrics();
    refreshStats();
    refreshHistory();
}, 10000);
</script>

<script th:replace="~{fragments/layout :: themeScript}"></script>
</body>
</html>
