<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('API Explorer')}"></head>
<body>
<nav th:replace="~{fragments/layout :: nav('explorer')}"></nav>

<div class="container-wide">
    <div class="page-header">
        <h1>API Explorer</h1>
        <p class="subtitle">Test any endpoint interactively with syntax-highlighted responses</p>
    </div>

    <div class="card">
        <h2>Send a Request</h2>
        <div class="api-form">
            <select id="method-select" class="api-input" style="flex:0 0 100px">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
            <input type="text" class="api-input" id="url-input" placeholder="/hello-world?name=Spring" value="/hello-world?name=Spring">
            <button class="btn btn-primary" onclick="sendRequest()">Send</button>
        </div>

        <!-- Quick endpoint buttons -->
        <div class="quick-links">
            <span class="quick-label">Quick:</span>
            <button class="btn btn-sm btn-secondary" onclick="setUrl('/hello-world?name=World')">/hello-world</button>
            <button class="btn btn-sm btn-accent" onclick="setUrl('/api/actuator/health')">Health</button>
            <button class="btn btn-sm btn-accent" onclick="setUrl('/api/actuator/info')">Info</button>
            <button class="btn btn-sm btn-accent" onclick="setUrl('/api/actuator/metrics')">Metrics</button>
            <button class="btn btn-sm btn-warm" onclick="setUrl('/api/actuator/env')">Env</button>
            <button class="btn btn-sm btn-warm" onclick="setUrl('/api/actuator/beans')">Beans</button>
            <button class="btn btn-sm btn-warm" onclick="setUrl('/api/system')">System</button>
            <button class="btn btn-sm btn-secondary" onclick="setUrl('/api/metrics/latest')">Metrics Live</button>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h2>Response</h2>
            <div class="response-meta" id="response-meta" style="display:none">
                <span id="resp-status"></span>
                <span id="resp-time"></span>
                <span id="resp-size"></span>
            </div>
            <div class="response-box" id="response-body">Click "Send" to make a request</div>
            <div class="response-actions" id="response-actions" style="display:none">
                <button class="btn btn-xs btn-outline" onclick="copyResponse()">Copy Response</button>
                <button class="btn btn-xs btn-outline" onclick="copyCurl()">Copy as cURL</button>
                <button class="btn btn-xs btn-outline" onclick="toggleJsonTree()">Toggle Tree/Raw</button>
            </div>
        </div>

        <div class="card">
            <h2>Response Headers</h2>
            <div class="response-box" id="response-headers">Headers will appear here</div>
        </div>
    </div>

    <!-- Request History -->
    <div class="card">
        <h2>Request History</h2>
        <table>
            <thead>
                <tr>
                    <th>Method</th>
                    <th>URL</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th>Trend</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="history-body">
                <tr><td colspan="6" style="color:var(--text-muted);text-align:center">No requests yet</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
var requestLog = [];
var lastRawResponse = '';
var lastParsedJson = null;
var showingTree = true;
var responseTimes = [];

// === Status Code Explanations ===
var STATUS_INFO = {
    200: 'OK - The request succeeded',
    201: 'Created - New resource created',
    204: 'No Content - Success with no body',
    301: 'Moved Permanently - Resource relocated',
    304: 'Not Modified - Cached version is current',
    400: 'Bad Request - Invalid syntax',
    401: 'Unauthorized - Authentication required',
    403: 'Forbidden - Access denied',
    404: 'Not Found - Resource does not exist',
    405: 'Method Not Allowed',
    500: 'Internal Server Error',
    502: 'Bad Gateway',
    503: 'Service Unavailable'
};

// === JSON Tree Renderer ===
function renderJsonTree(obj, depth) {
    if (depth === undefined) depth = 0;
    if (obj === null) return '<span class="json-null">null</span>';
    if (typeof obj === 'boolean') return '<span class="json-boolean">' + obj + '</span>';
    if (typeof obj === 'number') return '<span class="json-number">' + obj + '</span>';
    if (typeof obj === 'string') return '<span class="json-string">"' + escapeHtml(obj) + '"</span>';

    var isArray = Array.isArray(obj);
    var keys = isArray ? obj : Object.keys(obj);
    var count = isArray ? obj.length : keys.length;
    var openBracket = isArray ? '[' : '{';
    var closeBracket = isArray ? ']' : '}';

    if (count === 0) return '<span class="json-bracket">' + openBracket + closeBracket + '</span>';

    var id = 'jtree-' + Math.random().toString(36).substring(2, 8);
    var indent = '  '.repeat(depth + 1);
    var closeIndent = '  '.repeat(depth);

    var html = '<span class="json-toggle" onclick="toggleTreeNode(\'' + id + '\', this)">&#9660;</span>';
    html += '<span class="json-bracket">' + openBracket + '</span>';
    html += '<span class="json-ellipsis" style="display:none" onclick="toggleTreeNode(\'' + id + '\', this.previousElementSibling.previousElementSibling)">' + (isArray ? count + ' items' : count + ' keys') + '</span>';
    html += '<span id="' + id + '">';

    if (isArray) {
        for (var i = 0; i < obj.length; i++) {
            html += '\n' + indent + renderJsonTree(obj[i], depth + 1);
            if (i < obj.length - 1) html += ',';
        }
    } else {
        for (var k = 0; k < keys.length; k++) {
            html += '\n' + indent + '<span class="json-key">"' + escapeHtml(keys[k]) + '"</span>: ';
            html += renderJsonTree(obj[keys[k]], depth + 1);
            if (k < keys.length - 1) html += ',';
        }
    }

    html += '\n' + closeIndent + '<span class="json-bracket">' + closeBracket + '</span>';
    html += '</span>';
    return html;
}

function toggleTreeNode(id, toggleEl) {
    var el = document.getElementById(id);
    var ellipsis = toggleEl.nextElementSibling.nextElementSibling;
    if (el.classList.contains('json-collapsed')) {
        el.classList.remove('json-collapsed');
        ellipsis.style.display = 'none';
        toggleEl.classList.remove('collapsed');
    } else {
        el.classList.add('json-collapsed');
        ellipsis.style.display = 'inline';
        toggleEl.classList.add('collapsed');
    }
}

function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// === Sparkline SVG for Response Times ===
function renderTimeSvg(times) {
    if (times.length < 2) return '';
    var w = 80, h = 20;
    var max = Math.max.apply(null, times);
    var min = Math.min.apply(null, times);
    var range = max - min || 1;
    var points = times.map(function(t, i) {
        var x = (i / (times.length - 1)) * w;
        var y = h - ((t - min) / range) * (h - 4) - 2;
        return x.toFixed(1) + ',' + y.toFixed(1);
    }).join(' ');
    return '<svg width="' + w + '" height="' + h + '" style="vertical-align:middle;"><polyline points="' + points + '" fill="none" stroke="var(--primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
}

// === Core Request Functions ===
function setUrl(url) {
    document.getElementById('url-input').value = url;
    document.getElementById('method-select').value = 'GET';
    sendRequest();
}

function sendRequest() {
    var url = document.getElementById('url-input').value;
    var method = document.getElementById('method-select').value;

    var start = performance.now();
    document.getElementById('response-body').textContent = 'Loading...';
    document.getElementById('response-body').className = 'response-box';

    fetch(url, { method: method })
        .then(function(r) {
            var elapsed = Math.round(performance.now() - start);
            var status = r.status + ' ' + r.statusText;

            // Show headers
            var headers = [];
            r.headers.forEach(function(val, key) {
                headers.push(key + ': ' + val);
            });
            document.getElementById('response-headers').textContent = headers.join('\n');

            return r.text().then(function(text) {
                var meta = document.getElementById('response-meta');
                meta.style.display = 'flex';
                var statusEl = document.getElementById('resp-status');
                var tooltip = STATUS_INFO[r.status] || '';
                if (tooltip) statusEl.setAttribute('data-tooltip', tooltip);
                statusEl.textContent = status;
                statusEl.className = r.ok ? 'meta-success' : 'meta-error';
                document.getElementById('resp-time').textContent = elapsed + 'ms';
                document.getElementById('resp-size').textContent = text.length + ' bytes';
                document.getElementById('response-actions').style.display = 'flex';

                lastRawResponse = text;
                lastParsedJson = null;
                showingTree = true;

                try {
                    lastParsedJson = JSON.parse(text);
                    var respBox = document.getElementById('response-body');
                    respBox.className = 'response-box json-tree';
                    respBox.innerHTML = renderJsonTree(lastParsedJson, 0);
                } catch(e) {
                    document.getElementById('response-body').textContent = text;
                }

                addToLog(method, url, r.status, elapsed);
            });
        })
        .catch(function(e) {
            document.getElementById('response-body').textContent = 'Error: ' + e.message;
            document.getElementById('response-headers').textContent = '';
            var meta = document.getElementById('response-meta');
            meta.style.display = 'flex';
            document.getElementById('resp-status').textContent = 'Failed';
            document.getElementById('resp-status').className = 'meta-error';
            document.getElementById('resp-time').textContent = '';
            document.getElementById('resp-size').textContent = '';
            document.getElementById('response-actions').style.display = 'none';
            addToLog(method, url, 'ERR', 0);
        });
}

// === Copy Functions ===
function copyResponse() {
    var text = lastParsedJson ? JSON.stringify(lastParsedJson, null, 2) : lastRawResponse;
    navigator.clipboard.writeText(text).then(function() {
        showToast('Response copied to clipboard');
    });
}

function copyCurl() {
    var method = document.getElementById('method-select').value;
    var url = document.getElementById('url-input').value;
    var curl = 'curl -X ' + method + ' http://localhost:9000' + url;
    navigator.clipboard.writeText(curl).then(function() {
        showToast('cURL command copied');
    });
}

function toggleJsonTree() {
    var respBox = document.getElementById('response-body');
    if (!lastParsedJson) return;
    if (showingTree) {
        respBox.className = 'response-box';
        respBox.textContent = JSON.stringify(lastParsedJson, null, 2);
        showingTree = false;
    } else {
        respBox.className = 'response-box json-tree';
        respBox.innerHTML = renderJsonTree(lastParsedJson, 0);
        showingTree = true;
    }
}

// === History ===
function addToLog(method, url, status, time) {
    requestLog.unshift({ method: method, url: url, status: status, time: time });
    if (requestLog.length > 20) requestLog.pop();
    responseTimes.push(time);
    if (responseTimes.length > 20) responseTimes.shift();
    renderLog();
}

function renderLog() {
    var body = document.getElementById('history-body');
    body.innerHTML = requestLog.map(function(h) {
        var statusClass = (h.status >= 200 && h.status < 300) ? 'meta-success' : 'meta-error';
        var tooltip = STATUS_INFO[h.status] || '';
        var tooltipAttr = tooltip ? ' data-tooltip="' + escapeHtml(tooltip) + '"' : '';
        return '<tr>' +
            '<td><span class="method-badge ' + h.method.toLowerCase() + '">' + h.method + '</span></td>' +
            '<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"><code>' + escapeHtml(h.url) + '</code></td>' +
            '<td><span class="' + statusClass + '"' + tooltipAttr + '>' + h.status + '</span></td>' +
            '<td>' + h.time + 'ms</td>' +
            '<td>' + renderTimeSvg(responseTimes) + '</td>' +
            '<td><button class="btn btn-xs btn-outline" onclick="replayRequest(\'' + escapeHtml(h.method) + '\',\'' + escapeHtml(h.url) + '\')">Replay</button></td>' +
            '</tr>';
    }).join('');
}

function replayRequest(method, url) {
    document.getElementById('method-select').value = method;
    document.getElementById('url-input').value = url;
    sendRequest();
}

document.getElementById('url-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') sendRequest();
});
</script>

<div th:replace="~{fragments/layout :: shortcuts}"></div>
<div th:replace="~{fragments/layout :: toasts}"></div>
<script th:replace="~{fragments/layout :: themeScript}"></script>
</body>
</html>
