<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Person - ' + ${person.name})}"></head>
<body>
<nav th:replace="~{fragments/layout :: nav('people')}"></nav>
<div class="container">
    <a class="back-link" th:href="@{/people}">&larr; Back to list</a>

    <div th:replace="~{fragments/layout :: alerts}"></div>

    <div class="card">
        <h1 th:text="${person.name}">Name</h1>
        <div style="margin-top: 16px;">
            <div class="detail-row">
                <span class="detail-label">Email</span>
                <span class="detail-value" th:text="${person.email ?: 'Not set'}"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Role</span>
                <span class="detail-value" th:text="${person.role ?: 'Not set'}"></span>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:16px;">
            <a class="btn btn-primary" th:href="@{/people/{id}/edit(id=${person.id})}">Edit</a>
            <form th:action="@{/people/{id}/delete(id=${person.id})}" method="post"
                  onsubmit="return confirm('Are you sure you want to delete this person?');">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>Teammates (<span th:text="${person.teammates.size()}"></span>)</h2>

        <div th:if="${person.teammates.isEmpty()}" class="empty-state" style="padding:20px;">No teammates yet.</div>

        <ul class="teammate-list" th:unless="${person.teammates.isEmpty()}">
            <li class="teammate-item" th:each="teammate : ${person.teammates}">
                <a th:href="@{/people/{id}(id=${teammate.id})}" th:text="${teammate.name}"></a>
                <form th:action="@{/people/{pid}/teammates/{tid}/remove(pid=${person.id}, tid=${teammate.id})}"
                      method="post" style="margin:0;">
                    <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                </form>
            </li>
        </ul>

        <div th:unless="${#lists.isEmpty(availableTeammates)}">
            <form class="add-teammate" method="post" id="addTeammateForm">
                <select id="teammateSelect">
                    <option value="">-- Select a person --</option>
                    <option th:each="p : ${availableTeammates}" th:value="${p.id}" th:text="${p.name}"></option>
                </select>
                <button type="button" class="btn btn-primary btn-sm" onclick="addTeammate()">Add Teammate</button>
            </form>
            <script th:inline="javascript">
                var personId = /*[[${person.id}]]*/ 0;
                function addTeammate() {
                    var select = document.getElementById('teammateSelect');
                    var tid = select.value;
                    if (!tid) { alert('Please select a person'); return; }
                    var form = document.getElementById('addTeammateForm');
                    form.action = '/people/' + personId + '/teammates/' + tid;
                    form.submit();
                }
            </script>
        </div>
    </div>

    <!-- Suggested Connections (populated by JS from API) -->
    <div class="card" id="suggestionsCard" style="display:none;">
        <h2>Suggested Connections</h2>
        <p class="subtitle">People connected to your teammates you might want to connect with</p>
        <div id="suggestionsList"></div>
    </div>

    <script th:inline="javascript">
        var currentPersonId = /*[[${person.id}]]*/ 0;
        fetch('/api/suggestions/' + currentPersonId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data || data.length === 0) return;
                document.getElementById('suggestionsCard').style.display = 'block';
                var list = document.getElementById('suggestionsList');
                data.forEach(function(s) {
                    var div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML =
                        '<div class="suggestion-info">' +
                            '<a href="/people/' + s.id + '">' + s.name + '</a>' +
                            '<div class="mutual">' + s.mutualFriends + ' mutual connection(s)</div>' +
                        '</div>' +
                        '<form method="post" action="/people/' + currentPersonId + '/teammates/' + s.id + '" style="margin:0;">' +
                            '<button type="submit" class="btn btn-primary btn-sm">Connect</button>' +
                        '</form>';
                    list.appendChild(div);
                });
            })
            .catch(function() {});
    </script>
</div>
</body>
</html>
